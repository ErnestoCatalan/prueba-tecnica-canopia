<div class="product-container">
  <div class="header">
    <h2>Lista de Productos</h2>
    <button
      pButton
      label="Nuevo Producto"
      icon="pi pi-plus"
      (click)="showDialogToAdd()"
    ></button>
  </div>

  <p-table
    [value]="products"
    [paginator]="true"
    [rows]="10"
    [loading]="loading"
    styleClass="p-datatable-striped"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Categoría</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-product>
      <tr>
        <td>{{ product.name }}</td>
        <td>{{ product.description }}</td>
        <td>{{ product.price | currency }}</td>
        <td>{{ product.stock }}</td>
        <td>{{ getCategoryName(product.category_id) }}</td>
        <td>
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-rounded p-button-success mr-2"
            (click)="editProduct(product)"
          ></button>
          <button
            pButton
            icon="pi pi-trash"
            class="p-button-rounded p-button-danger"
            (click)="confirmDelete(product.id)"
          ></button>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">
          {{ loading ? 'Cargando...' : 'No se encontraron productos' }}
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-dialog
    header="{{ selectedProduct ? 'Editar Producto' : 'Nuevo Producto' }}"
    [(visible)]="displayDialog"
    [style]="{ width: '450px' }"
    [modal]="true"
  >
    <div class="p-fluid">
      <div class="field">
        <label for="name">Nombre</label>
        <input
          id="name"
          type="text"
          pInputText
          [(ngModel)]="newProduct.name"
          name="name"
          required
          class="w-full"
          [ngClass]="{'p-invalid': formSubmitted && (!newProduct.name || newProduct.name.length < 3)}"
        />
        <small *ngIf="formSubmitted && (!newProduct.name || newProduct.name.length < 3)" class="p-error">
          Nombre requerido (mínimo 3 caracteres)
        </small>
      </div>

      <div class="field">
        <label for="description">Descripción</label>
        <textarea
          id="description"
          pInputTextarea
          [(ngModel)]="newProduct.description"
          name="description"
          rows="3"
          required
          class="w-full"
          [ngClass]="{'p-invalid': formSubmitted && (!newProduct.description || newProduct.description.length < 10)}"
        ></textarea>
        <small *ngIf="formSubmitted && (!newProduct.description || newProduct.description.length < 5)" class="p-error">
          Descripción requerida (mínimo 5 caracteres)
        </small>
      </div>

      <div class="field">
        <label for="price">Precio</label>
        <p-inputNumber
          id="price"
          [(ngModel)]="newProduct.price"
          name="price"
          mode="currency"
          currency="USD"
          locale="en-US"
          [min]="0.01"
          [step]="0.01"
          required
          class="w-full"
          [ngClass]="{'p-invalid': formSubmitted && (!newProduct.price || newProduct.price <= 0)}"
        ></p-inputNumber>
        <small *ngIf="formSubmitted && (!newProduct.price || newProduct.price <= 0)" class="p-error">
          Precio debe ser mayor que 0
        </small>
      </div>

      <div class="field">
        <label for="stock">Stock</label>
        <p-inputNumber
          id="stock"
          [(ngModel)]="newProduct.stock"
          name="stock"
          [min]="0"
          required
          class="w-full"
          [ngClass]="{'p-invalid': formSubmitted && (newProduct.stock === undefined || newProduct.stock < 0)}"
        ></p-inputNumber>
        <small *ngIf="formSubmitted && (newProduct.stock === undefined || newProduct.stock < 0)" class="p-error">
          Stock no puede ser negativo
        </small>
      </div>

      <div class="field" *ngIf="categories.length > 0">
        <label for="category">Categoría</label>
        <p-selectButton
          id="category"
          [options]="categories"
          [(ngModel)]="newProduct.category_id"
          optionLabel="name"
          optionValue="id"
          required
          placeholder="Seleccione una categoría"
          class="w-full"
          [ngClass]="{'p-invalid': formSubmitted && !newProduct.category_id}"
        ></p-selectButton>
        <small *ngIf="formSubmitted && !newProduct.category_id" class="p-error">
          Debe seleccionar una categoría
        </small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        label="Cancelar"
        icon="pi pi-times"
        class="p-button-text"
        (click)="displayDialog = false"
      ></button>
      <button
        pButton
        label="Guardar"
        icon="pi pi-check"
        (click)="saveProduct()"
      ></button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog></p-confirmDialog>
</div>
